<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MCP WordPress • Login</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%23111'/%3E%3Ctext x='16' y='21' text-anchor='middle' font-size='14' fill='%23fff' font-family='Arial'%3EWP%3C/text%3E%3C/svg%3E" />
  <style>
    :root { --bg:#0b0f14; --card:#121820; --text:#e6edf3; --muted:#9fb1c4; --accent:#4f7fff; --accent-2:#7f56d9; --danger:#ff4f6d; }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(135deg,#0b0f14 0%,#0e141b 50%,#101722 100%);color:var(--text);font:500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px}
    .panel{width:100%;max-width:640px;background:linear-gradient(180deg,#151b23,#121820);border:1px solid #1d2530;border-radius:16px;box-shadow:0 30px 60px rgba(0,0,0,.35);display:grid;grid-template-columns:1fr;overflow:hidden}
    .panel.two{grid-template-columns:1fr 1fr}
    .left{padding:36px 40px;border-right:1px solid #1d2530}
    .right{padding:36px 40px}
    h1{margin:0 0 8px;font-size:28px} p.muted{color:var(--muted);margin:0 0 24px}
    .tabs{display:flex;gap:8px;margin-bottom:20px}
    .tab{flex:1;padding:10px 14px;text-align:center;border:1px solid #263042;border-radius:10px;background:#141a23;color:var(--muted);cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#1b2330,#182133);border-color:#2a364a;color:var(--text)}
    .field{margin-bottom:14px}
    label{display:block;margin-bottom:6px;color:#c8d4e2;font-size:13px}
    input{width:100%;height:42px;border:1px solid #263042;background:#0f141b;color:var(--text);border-radius:10px;padding:0 12px;outline:none}
    input:focus{border-color:#3b4b65;box-shadow:0 0 0 4px rgba(79,127,255,.15)}
    .pwd{position:relative}
    .pwd .toggle{position:absolute;right:8px;top:50%;transform:translateY(-50%);height:30px;width:34px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;color:#9fb1c4;cursor:pointer}
    .pwd .toggle:hover{color:#cfe3ff}
    .strength{height:8px;background:#1a2330;border:1px solid #263042;border-radius:6px;overflow:hidden;margin-top:8px}
    .strength .bar{height:100%;width:0;background:var(--danger);transition:width .2s ease, background .2s ease}
    .strength.medium .bar{background:var(--accent)}
    .strength.strong .bar{background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .row{display:flex;gap:12px}
    button{height:42px;border:none;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:600;cursor:pointer}
    .view button{width:100%}
    button.secondary{background:#192232;color:#cfe3ff;border:1px solid #2a364a}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .list{border:1px solid #263042;border-radius:12px;overflow:hidden}
    .item{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1d2530}
    .item:last-child{border-bottom:none}
    .token{font-family:ui-monospace, Menlo, Consolas; color:#9ca3af}
    .token.revoked{text-decoration:line-through;opacity:.7}
    .hidden{display:none}
    .error{color:var(--danger);font-size:13px;margin-top:8px}
    .tooltip{position:fixed;z-index:50;background:#111827;color:#fff;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.25);padding:10px 12px;transform:translate(0,-50%);min-width:180px;text-align:center;pointer-events:none}
    .tooltip .t-title{font-weight:800;margin-bottom:4px}
    .tooltip .t-desc{font-size:12px;opacity:.85}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{width:100%;max-width:520px;background:#141a23;border:1px solid #263042;border-radius:16px;box-shadow:0 24px 48px rgba(0,0,0,.5);padding:18px;color:#e6edf3}
    .modal .m-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-weight:800}
    .modal .m-actions{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="left">
        <h1>Bem-vindo</h1>
        <p class="muted">Entre ou crie sua conta para gerenciar conexões WordPress.</p>
        <div class="tabs">
          <div class="tab active" data-tab="login">Login</div>
          <div class="tab" data-tab="register">Cadastro</div>
          <div class="tab" data-tab="forgot">Recuperar senha</div>
        </div>
        <form id="login" class="view">
          <div class="field"><label>Email ou Telefone</label><input id="login-id" placeholder="email@dominio.com ou (11) 99999-9999" /></div>
          <div class="field pwd"><label>Senha</label><input id="login-pass" type="password" placeholder="••••••••" /><button type="button" class="toggle" aria-label="Mostrar/Ocultar" data-target="login-pass">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 5c-7.633 0-10 7-10 7s2.367 7 10 7 10-7 10-7-2.367-7-10-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg>
          </button></div>
          <button type="submit" id="login-btn">Entrar</button>
          <div class="error" id="login-err"></div>
        </form>
        <form id="register" class="view hidden">
          <div class="field"><label>Nome</label><input id="reg-name" placeholder="Seu nome" /></div>
          <div class="field"><label>Email</label><input id="reg-email" placeholder="email@dominio.com" /></div>
          <div class="field"><label>Telefone</label><input id="reg-phone" placeholder="+55 11 99999-9999" maxlength="20" inputmode="tel" autocomplete="tel" /></div>
          <div class="field pwd"><label>Senha</label><input id="reg-pass" type="password" placeholder="••••••••" /><button type="button" class="toggle" aria-label="Mostrar/Ocultar" data-target="reg-pass">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 5c-7.633 0-10 7-10 7s2.367 7 10 7 10-7 10-7-2.367-7-10-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg>
          </button></div>
          <div class="strength" id="reg-strength"><div class="bar"></div></div>
          <div class="field pwd"><label>Confirmar senha</label><input id="reg-pass2" type="password" placeholder="••••••••" /><button type="button" class="toggle" aria-label="Mostrar/Ocultar" data-target="reg-pass2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 5c-7.633 0-10 7-10 7s2.367 7 10 7 10-7 10-7-2.367-7-10-7Zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg>
          </button></div>
          <button type="submit" id="reg-btn">Cadastrar</button>
          <div class="error" id="reg-err"></div>
        </form>
        <form id="forgot" class="view hidden">
          <div class="field"><label>Email ou Telefone</label><input id="forgot-id" placeholder="email@dominio.com ou (11) 99999-9999" /></div>
          <button type="button" id="forgot-btn">Enviar instruções</button>
          <div class="error" id="forgot-err"></div>
        </form>
        <form id="conn-form" class="hidden" style="margin-top:12px">
          <div class="row">
            <div class="field" style="flex:2"><label>URL WordPress</label><input id="conn-url" placeholder="https://seusite.com" /></div>
            <div class="field" style="flex:1"><label>Usuário</label><input id="conn-user" placeholder="admin" /></div>
          </div>
          <div class="field"><label>App Password</label><input id="conn-pass" placeholder="abcd efgh ijkl mnop" /></div>
          <button type="button" id="conn-add">Cadastrar conexão</button>
          <div class="error" id="conn-err"></div>
        </form>
      </div>
      <div class="right hidden">
        <div class="topbar"><div id="user-name">Não autenticado</div><button class="secondary" id="logout">Sair</button></div>
        <div class="list" id="conn-list"></div>
      </div>
    </div>
  </div>
  <script>
    const iconScript=document.createElement('script');iconScript.src='https://unpkg.com/lucide@latest/dist/umd/lucide.min.js';document.head.appendChild(iconScript);
    const state = { token:null, user:null };
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t=>t.onclick=()=>{tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));document.getElementById(t.dataset.tab).classList.remove('hidden')});
    function maskPhone(v){
      let s = String(v).replace(/\D/g,'');
      if(s.startsWith('0055')) s = s.slice(2);
      const cc = '+55';
      // Sempre usar formato com DDI do Brasil
      if(s.startsWith('55')){
        if(s.length>13) s = s.slice(0,13);
        const tail = s.slice(2);
        if(tail.length<=2) return `${cc} ${tail}`.trim();
        const area = tail.slice(0,2);
        const rest = tail.slice(2);
        if(rest.length<=5) return `${cc} ${area} ${rest}`.trim();
        return `${cc} ${area} ${rest.slice(0,5)}-${rest.slice(5)}`.trim();
      } else {
        // Número local: prefixa +55 e aplica a mesma lógica progressiva
        if(s.length>11) s = s.slice(0,11);
        if(s.length<=2) return `${cc} ${s}`.trim();
        const area = s.slice(0,2);
        const rest = s.slice(2);
        if(rest.length<=5) return `${cc} ${area} ${rest}`.trim();
        return `${cc} ${area} ${rest.slice(0,5)}-${rest.slice(5)}`.trim();
      }
    }
    function friendly(msg){
      const m = String(msg||'').trim();
      const map = {
        missing_fields: 'Preencha todos os campos',
        invalid_email: 'Email inválido',
        weak_password: 'A senha precisa ter pelo menos 8 caracteres',
        email_exists: 'Este e-mail já está cadastrado',
        phone_exists: 'Este telefone já está cadastrado',
        invalid_credentials: 'Usuário ou senha inválidos',
        method_not_allowed: 'Método não permitido',
        provider_not_found: 'Provider não encontrado'
      };
      return map[m] || m || 'Erro inesperado';
    }
    const regPhoneEl = document.getElementById('reg-phone');
    const applyMask = (e)=>{ e.target.value = maskPhone(e.target.value); };
    regPhoneEl.addEventListener('input', applyMask);
    regPhoneEl.addEventListener('change', applyMask);
    regPhoneEl.addEventListener('blur', applyMask);
    regPhoneEl.addEventListener('paste', (e)=>{ setTimeout(()=>applyMask(e),0); });
    document.getElementById('login-id').addEventListener('input', e=>{
      const val = e.target.value || '';
      if(/^[+\d\s()-]+$/.test(val)){
        e.target.value = maskPhone(val);
      }
    });
    async function api(path, method, body){ const res = await fetch(path,{ method, headers:{ 'Content-Type':'application/json', ...(state.token?{ Authorization:`Bearer ${state.token}` }:{} ) }, body: body?JSON.stringify(body):undefined }); const data = await res.json(); if(!res.ok) throw new Error(data.error||'erro'); return data; }
    function itemRow(x){ const token = x.token || ''; const last4 = x.token_last4 || (token ? token.slice(-4) : ''); const revoked=(String(x.status||'').toLowerCase()==='revoked'); const tokenCls=revoked?'token revoked':'token'; const revokeBtn = revoked? '' : `<button class='secondary' data-act='revoke' data-tip-title='Revogar token' data-tip-desc='Invalida o token'><i data-lucide='ban'></i></button>`; return `<div class='item' data-id='${x.id}'><div><div>${x.config?.url||''}</div><div class='${tokenCls}'>token=${token}</div></div><div style='display:flex;gap:8px;align-items:center'><button class='secondary' data-act='copy-token' data-tip-title='Copiar token' data-tip-desc='Copia para o clipboard'><i data-lucide='copy'></i></button><button class='secondary' data-act='rotate' data-tip-title='Rotacionar token' data-tip-desc='Gera novo token'><i data-lucide='refresh-ccw'></i></button>${revokeBtn}<button class='secondary' data-act='test' data-tip-title='Testar conexão' data-tip-desc='Verifica credenciais'><i data-lucide='check-circle'></i></button><button class='secondary' data-act='delete' data-tip-title='Excluir conexão' data-tip-desc='Remove esta conexão'><i data-lucide='trash-2'></i></button></div></div>`; }
    function openModal(title, bodyHtml, actions){ const ov=document.createElement('div'); ov.className='modal-overlay'; const md=document.createElement('div'); md.className='modal'; md.innerHTML = `<div class='m-head'>${title}<button class='secondary' id='m-close'><i data-lucide="x"></i></button></div><div class='m-body'>${bodyHtml}</div><div class='m-actions'></div>`; ov.appendChild(md); document.body.appendChild(ov); if(window.lucide&&window.lucide.createIcons) window.lucide.createIcons(); const actBox=md.querySelector('.m-actions'); const btns=(actions||[{label:'Fechar'}]); btns.forEach(b=>{ const el=document.createElement('button'); el.className=b.variant==='primary'?'':'secondary'; el.textContent=b.label; el.onclick=()=>{ if(b.onClick) b.onClick(); document.body.removeChild(ov); }; actBox.appendChild(el); }); md.querySelector('#m-close').onclick=()=>{ document.body.removeChild(ov); };
      return { overlay:ov, modal:md }; }
    function confirmModal(title, desc, onConfirm){ openModal(title, `<div style='text-align:center'>${desc}</div>`, [{label:'Cancelar',variant:'secondary'},{label:'Confirmar',variant:'primary',onClick:onConfirm}]); }
    function renderIcons(){ if(window.lucide&&window.lucide.createIcons) window.lucide.createIcons(); }
    async function refreshConnections(){ try{ const data = await api('/api/connections','GET'); const list = document.getElementById('conn-list'); list.innerHTML = (data.items||[]).map(itemRow).join('') || '<div class="item">Nenhuma conexão</div>'; renderIcons(); }catch(e){ document.getElementById('conn-err').innerText=e.message; } }
    async function doRegister(e){ if(e) e.preventDefault(); const name=document.getElementById('reg-name').value.trim(); const email=document.getElementById('reg-email').value.trim(); const phone=document.getElementById('reg-phone').value.trim(); const pass=document.getElementById('reg-pass').value; const pass2=document.getElementById('reg-pass2').value; if(pass2 && pass!==pass2){ document.getElementById('reg-err').innerText='As senhas não coincidem'; return; } try{ await api('/api/auth/register','POST',{name,email,phone,password:pass}); const data = await api('/api/auth/login','POST',{emailOrPhone:email,password:pass}); state.token=data.token; state.user=data.user; sessionStorage.setItem('token', data.token); sessionStorage.setItem('user', JSON.stringify(data.user)); document.getElementById('reg-err').innerText=''; window.location.href = '/app'; }catch(e){ document.getElementById('reg-err').innerText=friendly(e.message); }
    }
    async function doLogin(e){ if(e) e.preventDefault(); const id=document.getElementById('login-id').value.trim(); const pass=document.getElementById('login-pass').value; try{ const data = await api('/api/auth/login','POST',{emailOrPhone:id,password:pass}); state.token=data.token; state.user=data.user; sessionStorage.setItem('token', data.token); sessionStorage.setItem('user', JSON.stringify(data.user)); window.location.href = '/app'; }catch(e){ document.getElementById('login-err').innerText=friendly(e.message); } }
    document.getElementById('login').addEventListener('submit', doLogin);
    document.getElementById('login-btn').onclick = doLogin;
    document.getElementById('register').addEventListener('submit', doRegister);
    document.getElementById('reg-btn').onclick = doRegister;
    document.getElementById('forgot-btn').onclick = async ()=>{ const id=document.getElementById('forgot-id').value.trim(); try{ await api('/api/auth/request-reset','POST',{emailOrPhone:id}); alert('Se existir uma conta, enviamos instruções.'); }catch(e){ document.getElementById('forgot-err').innerText=e.message; } };
    document.getElementById('conn-add').onclick = async ()=>{ const url=document.getElementById('conn-url').value.trim(); const user=document.getElementById('conn-user').value.trim(); const pass=document.getElementById('conn-pass').value; try{ const resp = await api('/api/connections','POST',{ provider:'wordpress', name:user||'WordPress', config:{ url }, secrets:{ username:user, app_password:pass } }); await refreshConnections(); document.getElementById('conn-err').innerText=''; alert('Conexão criada. Token: '+resp.token); document.getElementById('conn-url').value=''; document.getElementById('conn-user').value=''; document.getElementById('conn-pass').value=''; }catch(e){ document.getElementById('conn-err').innerText=e.message; } };
    document.getElementById('conn-list').addEventListener('click', async (e)=>{
      const t = e.target.closest('[data-act]');
      if(!t) return;
      const act = t.getAttribute('data-act');
      const item = t.closest('.item');
      const id = parseInt(item.getAttribute('data-id'));
      if(act==='copy-token'){
        try{ const data = await api(`/api/connections/${id}`,'GET'); const m = openModal('Copiar token', `<div style='text-align:center'><div class='field'><label>Token</label><input value='${data.token||''}' style='width:100%;height:42px;border:1px solid #263042;background:#0f141b;color:#e6edf3;border-radius:10px;padding:0 12px' /></div></div>`, [{label:'Copiar',variant:'primary',onClick:async()=>{ await navigator.clipboard.writeText(String(data.token||'')); }}]); m.modal.querySelector('.m-body input')?.setAttribute('readonly',''); }catch(err){ openModal('Erro', `<div style='text-align:center'>${err.message}</div>`); }
      }
      if(act==='rotate'){
        try{ const data = await api(`/api/connections/${id}/rotate-token`,'POST'); await refreshConnections(); const m2 = openModal('Novo token', `<div style='text-align:center'><div class='field'><label>Token</label><input value='${data.token||''}' style='width:100%;height:42px;border:1px solid #263042;background:#0f141b;color:#e6edf3;border-radius:10px;padding:0 12px' /></div></div>`, [{label:'Copiar',variant:'primary',onClick:async()=>{ await navigator.clipboard.writeText(String(data.token||'')); }}]); m2.modal.querySelector('.m-body input')?.setAttribute('readonly',''); }catch(err){ openModal('Erro', `<div style='text-align:center'>${err.message}</div>`); }
      }
      if(act==='revoke'){
        confirmModal('Revogar token', 'Deseja revogar o token desta conexão?', async()=>{ await api(`/api/connections/${id}/revoke`,'POST'); await refreshConnections(); });
      }
      if(act==='test'){
        try{ const data = await api(`/api/connections/${id}/test`,'POST'); openModal('Resultado do teste', `<div style='text-align:center'>${data.ok?'Conexão OK':'Falha'}<div class='token' style='margin-top:8px'>${data.info?.endpoint||''}</div><div class='error'>${data.info?.error||''}</div></div>`); }catch(err){ openModal('Erro', `<div style='text-align:center'>${err.message}</div>`); }
      }
      if(act==='delete'){
        confirmModal('Excluir conexão', 'Tem certeza que deseja excluir esta conexão?', async()=>{ await api(`/api/connections/${id}`,'DELETE'); await refreshConnections(); });
      }
    });
    const tipEl=document.createElement('div'); tipEl.className='tooltip'; tipEl.style.display='none'; tipEl.innerHTML = `<div class='t-title'></div><div class='t-desc'></div>`; document.body.appendChild(tipEl);
    function showTip(target){ const t=target.getAttribute('data-tip-title'); const d=target.getAttribute('data-tip-desc'); if(!t&&!d) return; const rect=target.getBoundingClientRect(); tipEl.querySelector('.t-title').innerText=t||''; tipEl.querySelector('.t-desc').innerText=d||''; tipEl.style.left=(rect.right+10)+"px"; tipEl.style.top=(rect.top+rect.height/2)+"px"; tipEl.style.display='block'; }
    function hideTip(){ tipEl.style.display='none'; }
    document.addEventListener('mouseover',(e)=>{ const btn=e.target.closest('[data-tip-title]'); if(btn) showTip(btn); });
    document.addEventListener('mouseout',(e)=>{ const btn=e.target.closest('[data-tip-title]'); if(btn) hideTip(); });
    iconScript.addEventListener('load', renderIcons);
    document.getElementById('logout').onclick = ()=>{ state.token=null; state.user=null; document.getElementById('user-name').innerText='Não autenticado'; document.getElementById('conn-form').classList.add('hidden'); document.getElementById('conn-list').innerHTML=''; document.querySelector('.right').classList.add('hidden'); document.querySelector('.panel').classList.remove('two'); document.querySelector('[data-tab="login"]').click(); };
    function togglePwd(targetId){ const input=document.getElementById(targetId); if(!input) return; input.type = input.type==='password' ? 'text' : 'password'; }
    document.querySelectorAll('.toggle').forEach(btn=>{ btn.addEventListener('click',()=> togglePwd(btn.dataset.target)); });
    function strengthScore(p){ let s=0; if(p.length>=8) s++; if(/[A-Z]/.test(p)) s++; if(/[a-z]/.test(p)) s++; if(/\d/.test(p)) s++; if(/[^\w\s]/.test(p)) s++; return Math.min(s,5); }
    function updateStrength(){ const p=document.getElementById('reg-pass').value||''; const box=document.getElementById('reg-strength'); const bar=box.querySelector('.bar'); const score=strengthScore(p); const pct=[0,20,40,70,85,100][score]; bar.style.width=pct+'%'; box.classList.remove('medium','strong'); if(score<=2){ } else if(score<=3){ box.classList.add('medium'); } else { box.classList.add('strong'); } }
    document.getElementById('reg-pass').addEventListener('input', updateStrength);
    updateStrength();
  </script>
</body>
</html>